{% extends "agency/base.html" %}
{% block title %}Бронирования{% endblock %}
{% block body %}
<div class="max-w-7xl mx-auto px-6 py-10">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-extrabold text-cyan-700">Бронирования</h1>
    <div class="flex gap-3 items-center">
      <input type="date" id="fromDate" class="border rounded px-2 py-1 text-sm" />
      <span>—</span>
      <input type="date" id="toDate" class="border rounded px-2 py-1 text-sm" />
      <button id="exportCsv" class="px-4 py-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700">Экспорт CSV</button>
    </div>
  </div>

  <!-- Bookings list -->
  <div id="bookingsContainer"></div>
</div>

<script>
(function(){

  const fetchBookings = async () => {
    try {
      const url = '/api/v1/agency/bookings/';
      const res = await fetch(url);
      const data = await res.json();
      
      return data || [];
    } catch (err) {
      console.error('Error fetching bookings:', err);
    }
  };

  const groupBy = (array, keyFn) => {
    const map = {};
    array.forEach(item => {
      const k = keyFn(item);
      (map[k] = map[k] || []).push(item);
    });
    return map;
  };

  const render = async () => {
    const bookings = await fetchBookings();
    console.log('Bookings to render:', bookings);
    const container = document.getElementById('bookingsContainer');
    container.innerHTML = '';

    if (!bookings.length) {
      container.innerHTML = '<div class="text-center py-8 text-gray-500">Нет бронирований</div>';
      return;
    }

    // group by tour_title
    const groups = groupBy(bookings, b => b.tour_title);

    Object.entries(groups).forEach(([title, rows]) => {
      // Sort rows: unviewed first
      rows.sort((a,b)=> (a.viewed === b.viewed ? 0 : a.viewed ? 1 : -1));

      const section = document.createElement('div');
      section.className = 'mb-10';
      section.innerHTML = `
        <h2 class="text-xl font-semibold text-gray-800 mb-3">${title}</h2>
        <div class="overflow-x-auto bg-white rounded-xl shadow">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Дата</th>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Отправление</th>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Турист</th>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Телефон</th>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Кол-во</th>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Сумма</th>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Детали</th>
                <th class="px-4 py-2 text-left font-medium text-gray-500">Статус</th>
                <th class="px-4 py-2"></th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              ${rows.map(r => `
                <tr class="${r.viewed ? '' : 'bg-amber-50'}">
                  <td class="px-4 py-2">${new Date(r.booking_date).toLocaleString()}</td>
                  <td class="px-4 py-2">${r.departure_date ? new Date(r.departure_date).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : ''}</td>
                  <td class="px-4 py-2">${r.customer_name}</td>
                  <td class="px-4 py-2">${r.customer_phone}</td>
                  <td class="px-4 py-2 text-center">${r.total_quantity}</td>
                  <td class="px-4 py-2">${r.total_amount}</td>
                  <td class="px-4 py-2 whitespace-nowrap">${r.categories.map(c => `${c.name} ×${c.quantity}`).join('<br/>')}</td>
                  <td class="px-4 py-2">${r.status || 'pending'}</td>
                  <td class="px-4 py-2 text-right whitespace-nowrap">
                    ${r.status === 'pending' ? `
                      <button data-id="${r.booking_id}" data-action="confirm" class="actBtn text-green-600 hover:text-green-800 mr-2">Подтвердить</button>
                      <button data-id="${r.booking_id}" data-action="reject" class="actBtn text-red-600 hover:text-red-800">Отклонить</button>
                    ` : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      container.appendChild(section);
    });

    attachActions();
  };

  const patchStatus = async (id, status) => {
    try {
      const url = `/api/v1/agency/bookings/${id}/status`;
      console.log('Patching status at URL:', url);
      
      const res = await fetch(url, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({status})
      });
      
      if (!res.ok) {
        console.error('Error changing status:', res.status, res.statusText);
        alert('Ошибка изменения статуса');
        return false;
      }
      
      return true;
    } catch (err) {
      console.error('Error updating booking status:', err);
      alert('Ошибка изменения статуса');
      return false;
    }
  };

  const attachActions = () => {
    document.querySelectorAll('.actBtn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.getAttribute('data-id');
        const action = e.target.getAttribute('data-action');
        if (!id || !action) return;
        await patchStatus(id, action === 'confirm' ? 'confirmed' : 'rejected');
        await render();
      });
    });
  };

  document.getElementById('exportCsv').addEventListener('click', () => {
    const fd = document.getElementById('fromDate').value;
    const td = document.getElementById('toDate').value;
    const params = new URLSearchParams();
    if (fd) params.append('from_date', fd);
    if (td) params.append('to_date', td);
    params.append('format', 'csv');
    
    window.open(`/api/v1/agency/bookings/?${params.toString()}`, '_blank');
  });

  render();
})();
</script>
{% endblock %}