{% extends "agency/base.html" %}
{% block title %}Мои экскурсии{% endblock %}
{% block body %}
<div class="max-w-7xl mx-auto px-6 py-10">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-extrabold text-cyan-700">Экскурсии</h1>
    <button id="newTourBtn" class="px-4 py-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700">+ Новая экскурсия</button>
  </div>

  <!-- Tours table -->
  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full divide-y divide-gray-200" id="toursTable">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Название</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Расписание</th>
          <th class="px-6 py-3"></th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="toursBody"></tbody>
    </table>
  </div>
</div>

<!-- Modal for new tour -->
<div id="tourModal" class="fixed inset-0 bg-black/50 flex items-start justify-center hidden overflow-y-auto py-10">
  <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 my-auto max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-semibold mb-4">Новая экскурсия</h2>
    <form id="tourForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1" for="tourTitle">Название</label>
        <input id="tourTitle" type="text" required class="w-full px-3 py-2 border rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="tourDesc">Описание</label>
        <textarea id="tourDesc" class="w-full px-3 py-2 border rounded"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="tourPrice">Базовая цена</label>
        <input id="tourPrice" type="number" step="0.01" min="0" required class="w-full px-3 py-2 border rounded" />
      </div>

      <div class="flex gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="tourCity">Город</label>
          <select id="tourCity" class="w-full px-3 py-2 border rounded"></select>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="tourCat">Категория</label>
          <select id="tourCat" class="w-full px-3 py-2 border rounded"></select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="tourImages">Фотографии</label>
        <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
          <p class="text-gray-500 mb-2">Перетащите изображения сюда или нажмите для выбора</p>
          <input id="tourImages" type="file" accept="image/*" multiple class="hidden" />
          <button type="button" id="selectImagesBtn" class="px-3 py-1 bg-cyan-600 text-white rounded">Выбрать файлы</button>
        </div>
        <div id="imagePreviewCarousel" class="mt-3 hidden">
          <h4 class="text-sm font-medium mb-2">Предпросмотр изображений:</h4>
          <div class="flex overflow-x-auto gap-2 pb-2" id="previewContainer"></div>
        </div>
      </div>

      <div>
        <h3 class="font-medium mb-2">Типы билетов</h3>
        <div id="ticketRows" class="space-y-2"></div>
        <div class="flex gap-2 mt-2">
          <select id="ticketClassSel" class="flex-1 border rounded px-2 py-1 text-sm"></select>
          <input id="ticketPriceInput" type="number" step="0.01" min="0" placeholder="Цена" class="flex-1 border rounded px-2 py-1 text-sm" />
          <button type="button" id="addTicketBtn" class="px-3 py-1 bg-emerald-600 text-white rounded">Добавить</button>
        </div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" id="cancelModal" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Отмена</button>
        <button type="submit" class="px-4 py-2 rounded bg-cyan-600 text-white hover:bg-cyan-700">Создать</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal for schedule configuration -->
<div id="scheduleModal" class="fixed inset-0 bg-black/50 flex items-start justify-center hidden overflow-y-auto py-10">
  <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6 my-auto max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-semibold mb-4">Настройка расписания</h2>
    <form id="scheduleForm" class="space-y-4">
      <input type="hidden" id="scheduleTourId">
      
      <div>
        <label class="block text-sm font-medium mb-1" for="repeatType">Тип повторения</label>
        <select id="repeatType" class="w-full px-3 py-2 border rounded">
          <option value="none">Без повторения</option>
          <option value="daily">Ежедневно</option>
          <option value="weekly">Еженедельно</option>
        </select>
      </div>
      
      <div id="timeSection" class="hidden">
        <label class="block text-sm font-medium mb-1" for="repeatTime">Время</label>
        <input type="time" id="repeatTime" class="w-full px-3 py-2 border rounded" value="09:00">
      </div>
      
      <div id="weekdaysSection" class="hidden">
        <label class="block text-sm font-medium mb-2">Дни недели</label>
        <div class="flex flex-wrap gap-2">
          <label class="inline-flex items-center px-3 py-1 bg-gray-100 rounded">
            <input type="checkbox" value="0" class="weekday-cb mr-1"> Пн
          </label>
          <label class="inline-flex items-center px-3 py-1 bg-gray-100 rounded">
            <input type="checkbox" value="1" class="weekday-cb mr-1"> Вт
          </label>
          <label class="inline-flex items-center px-3 py-1 bg-gray-100 rounded">
            <input type="checkbox" value="2" class="weekday-cb mr-1"> Ср
          </label>
          <label class="inline-flex items-center px-3 py-1 bg-gray-100 rounded">
            <input type="checkbox" value="3" class="weekday-cb mr-1"> Чт
          </label>
          <label class="inline-flex items-center px-3 py-1 bg-gray-100 rounded">
            <input type="checkbox" value="4" class="weekday-cb mr-1"> Пт
          </label>
          <label class="inline-flex items-center px-3 py-1 bg-gray-100 rounded">
            <input type="checkbox" value="5" class="weekday-cb mr-1"> Сб
          </label>
          <label class="inline-flex items-center px-3 py-1 bg-gray-100 rounded">
            <input type="checkbox" value="6" class="weekday-cb mr-1"> Вс
          </label>
        </div>
      </div>
      
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" id="cancelScheduleModal" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Отмена</button>
        <button type="submit" class="px-4 py-2 rounded bg-cyan-600 text-white hover:bg-cyan-700">Сохранить</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('tourModal');
  const newBtn = document.getElementById('newTourBtn');
  const cancelBtn = document.getElementById('cancelModal');

  const openModal = () => { modal.classList.remove('hidden'); };
  const closeModal = () => { modal.classList.add('hidden'); };

  newBtn.addEventListener('click', async () => {
    await preloadSelects();
    openModal();
  });
  cancelBtn.addEventListener('click', closeModal);

  const loadTours = async () => {
    const res = await fetch('/api/v1/agency/tours/list');
    if (!res.ok) return;
    const tours = await res.json();
    const body = document.getElementById('toursBody');
    body.innerHTML = '';
    tours.forEach(t => {
      const tr = document.createElement('tr');
      const badge = formatScheduleBadge(t);
      tr.innerHTML = `
        <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${t.id}</td>
        <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${t.title}</td>
        <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${t.price}</td>
        <td class='px-6 py-4 whitespace-nowrap text-sm space-x-1'>${badge} <button data-id="${t.id}" class="addSched px-2 rounded bg-gray-200 hover:bg-gray-300">＋</button></td>
        <td class='px-6 py-4 whitespace-nowrap text-right text-sm font-medium'></td>`;
      body.appendChild(tr);
    });
    body.querySelectorAll('.addSched').forEach(btn=>btn.addEventListener('click', (e)=>{
      const tid = e.target.getAttribute('data-id');
      openRecModal(tours.find(x=>x.id==tid));
    }));
  };

  const ticketRows = [];

  // Initial fetch
  loadTours();

  document.getElementById('addTicketBtn').addEventListener('click', () => {
    const clsSel = document.getElementById('ticketClassSel');
    const priceInput = document.getElementById('ticketPriceInput');
    const clsId = clsSel.value;
    const clsName = clsSel.options[clsSel.selectedIndex].text;
    const price = priceInput.value;
    if (!clsId || !price) return;
    ticketRows.push({ ticket_class_id: parseInt(clsId), name: clsName, price });
    renderTicketRows();
    priceInput.value = '';
  });

  const renderTicketRows = () => {
    const container = document.getElementById('ticketRows');
    container.innerHTML = ticketRows.map((r,i)=>`
      <div class="flex justify-between items-center bg-gray-50 px-3 py-1 rounded">
        <span>${r.name}</span>
        <span>${r.price}</span>
        <button data-idx="${i}" class="delTicket text-red-600">×</button>
      </div>
    `).join('');
    container.querySelectorAll('.delTicket').forEach(btn => {
      btn.addEventListener('click', (e)=>{
        const idx = e.target.getAttribute('data-idx');
        ticketRows.splice(idx,1);
        renderTicketRows();
      });
    });
  };

  async function preloadSelects(){
    // cities
    const cities = await fetch('/api/v1/public/cities').then(r=>r.json()).catch(()=>[]);
    const citySel = document.getElementById('tourCity');
    citySel.innerHTML = '<option value="">—</option>' + cities.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    // tour categories
    const tCats = await fetch('/api/v1/public/tour_categories').then(r=>r.json()).catch(()=>[]);
    const catSel = document.getElementById('tourCat');
    catSel.innerHTML = '<option value="">—</option>' + tCats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    // ticket classes
    const tClass = await fetch('/api/v1/public/ticket_classes').then(r=>r.json()).catch(()=>[]);
    const clsSel = document.getElementById('ticketClassSel');
    clsSel.innerHTML = '<option value="">Тип</option>' + tClass.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    // repetition types
    await loadRepetitionTypes();
  }

  // Handle drag and drop image functionality
  const dropArea = document.getElementById('dropArea');
  const imageInput = document.getElementById('tourImages');
  const selectImagesBtn = document.getElementById('selectImagesBtn');
  const imagePreviewCarousel = document.getElementById('imagePreviewCarousel');
  const previewContainer = document.getElementById('previewContainer');
  const selectedFiles = [];

  // Open file dialog when button is clicked
  selectImagesBtn.addEventListener('click', () => {
    imageInput.click();
  });

  // Handle file selection
  imageInput.addEventListener('change', handleFileSelect);

  // Drag and drop events
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
  });

  function highlight() {
    dropArea.classList.add('border-cyan-500', 'bg-cyan-50');
  }

  function unhighlight() {
    dropArea.classList.remove('border-cyan-500', 'bg-cyan-50');
  }

  // Handle the dropped files
  dropArea.addEventListener('drop', handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
  }

  function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
  }

  function handleFiles(files) {
    if (files.length === 0) return;
    
    // Clear previous previews if needed
    if (selectedFiles.length === 0) {
      previewContainer.innerHTML = '';
    }
    
    // Process each file
    Array.from(files).forEach(file => {
      if (!file.type.match('image.*')) return;
      
      selectedFiles.push(file);
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = 'relative flex-shrink-0';
        div.innerHTML = `
          <img src="${e.target.result}" class="h-24 w-auto rounded border border-gray-300" />
          <button type="button" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center remove-image">×</button>
        `;
        previewContainer.appendChild(div);
        
        // Add remove functionality
        div.querySelector('.remove-image').addEventListener('click', function() {
          const index = Array.from(previewContainer.children).indexOf(div);
          selectedFiles.splice(index, 1);
          div.remove();
          
          // Hide carousel if no images
          if (selectedFiles.length === 0) {
            imagePreviewCarousel.classList.add('hidden');
          }
        });
        
        // Show the preview carousel
        imagePreviewCarousel.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });
  }

  document.getElementById('tourForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('tourTitle').value.trim();
    const description = document.getElementById('tourDesc').value.trim();
    const price = document.getElementById('tourPrice').value;
    const city_id = document.getElementById('tourCity').value || null;
    const category_id = document.getElementById('tourCat').value || null;
    if (!title || !price) return;
    const res = await fetch('/api/v1/agency/tours/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description, price, city_id, category_id })
    });
    if (!res.ok) { alert('Ошибка при создании экскурсии'); return; }
    closeModal();
    document.getElementById('tourForm').reset();
    const { id } = await res.json();

    // Upload images if any
    if (selectedFiles.length > 0){
      const fd = new FormData();
      for (const f of selectedFiles) fd.append('files', f);
      await fetch(`/api/v1/agency/tours/${id}/images`, {method:'POST', body:fd});
    }

    // Add ticket categories
    for (const tc of ticketRows){
      await fetch(`/api/v1/agency/tours/${id}/categories`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(tc)
      });
    }

    ticketRows.length = 0;
    loadTours();
  });

  function fmtTime(t){return t?.slice(0,5);} // HH:MM
  const weekdaysRU=['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
  function formatScheduleBadge(t){
    if(t.repeat_type==='daily') return `<span class="inline-block px-2 bg-emerald-100 rounded">🗓 ${fmtTime(t.repeat_time)}</span>`;
    if(t.repeat_type==='weekly'){
      const days=t.repeat_weekdays.map(i=>weekdaysRU[i]).join(' ');
      return `<span class="inline-block px-2 bg-amber-100 rounded">⏲ ${fmtTime(t.repeat_time)} — ${days}</span>`;
    }
    return '<span class="inline-block px-2 bg-gray-100 rounded">—</span>';
  }

  // Schedule modal
  const scheduleModal = document.getElementById('scheduleModal');
  const scheduleForm = document.getElementById('scheduleForm');
  const repeatTypeSelect = document.getElementById('repeatType');
  const timeSection = document.getElementById('timeSection');
  const weekdaysSection = document.getElementById('weekdaysSection');
  const scheduleTourIdInput = document.getElementById('scheduleTourId');
  const repeatTimeInput = document.getElementById('repeatTime');
  const weekdayCbs = document.querySelectorAll('.weekday-cb');
  const cancelScheduleBtn = document.getElementById('cancelScheduleModal');

  // Show/hide sections based on repeat type
  repeatTypeSelect.addEventListener('change', () => {
    const type = repeatTypeSelect.value;
    timeSection.classList.toggle('hidden', type === 'none');
    weekdaysSection.classList.toggle('hidden', type !== 'weekly');
  });

  // Load repetition types
  async function loadRepetitionTypes() {
    try {
      const res = await fetch('/api/v1/public/repetition_types');
      if (!res.ok) throw new Error('Failed to load repetition types');
      
      const types = await res.json();
      repeatTypeSelect.innerHTML = types.map(t => 
        `<option value="${t.code}">${t.name}</option>`
      ).join('');
    } catch (err) {
      console.error('Error loading repetition types:', err);
      // Fallback to hardcoded values
      repeatTypeSelect.innerHTML = `
        <option value="none">Без повторения</option>
        <option value="daily">Ежедневно</option>
        <option value="weekly">Еженедельно</option>
      `;
    }
  }

  // Open schedule modal
  async function openRecModal(tour) {
    // Load repetition types if not already loaded
    if (repeatTypeSelect.children.length === 0) {
      await loadRepetitionTypes();
    }
    
    scheduleTourIdInput.value = tour.id;
    
    // Set initial values
    repeatTypeSelect.value = tour.repeat_type || 'none';
    
    // Set time if exists
    if (tour.repeat_time) {
      repeatTimeInput.value = tour.repeat_time.slice(0, 5); // HH:MM
    } else {
      repeatTimeInput.value = '09:00';
    }
    
    // Set weekdays if exists
    weekdayCbs.forEach(cb => cb.checked = false);
    if (tour.repeat_weekdays && Array.isArray(tour.repeat_weekdays)) {
      tour.repeat_weekdays.forEach(day => {
        const cb = document.querySelector(`.weekday-cb[value="${day}"]`);
        if (cb) cb.checked = true;
      });
    }
    
    // Show/hide sections based on type
    timeSection.classList.toggle('hidden', repeatTypeSelect.value === 'none');
    weekdaysSection.classList.toggle('hidden', repeatTypeSelect.value !== 'weekly');
    
    // Show modal
    scheduleModal.classList.remove('hidden');
  }
  
  // Close schedule modal
  cancelScheduleBtn.addEventListener('click', () => {
    scheduleModal.classList.add('hidden');
  });
  
  // Submit schedule form
  scheduleForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const tourId = scheduleTourIdInput.value;
    const type = repeatTypeSelect.value;
    const time = type !== 'none' ? repeatTimeInput.value : null;
    
    // Get selected weekdays
    let weekdays = null;
    if (type === 'weekly') {
      weekdays = Array.from(weekdayCbs)
        .filter(cb => cb.checked)
        .map(cb => parseInt(cb.value));
    }
    
    try {
      const res = await fetch(`/api/v1/agency/tours/${tourId}`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          repeat_type: type,
          repeat_weekdays: weekdays,
          repeat_time: time
        })
      });
      
      if (!res.ok) {
        throw new Error('Failed to update schedule');
      }
      
      scheduleModal.classList.add('hidden');
      loadTours();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  });
})();
</script>
{% endblock %} 