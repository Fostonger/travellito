{% extends "agency/base.html" %}
{% block title %}–ú–æ–∏ —ç–∫—Å–∫—É—Ä—Å–∏–∏{% endblock %}
{% block body %}
<div class="max-w-7xl mx-auto px-6 py-10">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-extrabold text-cyan-700">–≠–∫—Å–∫—É—Ä—Å–∏–∏</h1>
    <button id="newTourBtn" class="px-4 py-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700">+ –ù–æ–≤–∞—è —ç–∫—Å–∫—É—Ä—Å–∏—è</button>
  </div>

  <!-- Tours table -->
  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full divide-y divide-gray-200" id="toursTable">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¶–µ–Ω–∞</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</th>
          <th class="px-6 py-3"></th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200" id="toursBody"></tbody>
    </table>
  </div>
</div>

<!-- Modal for new tour -->
<div id="tourModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
  <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6">
    <h2 class="text-xl font-semibold mb-4">–ù–æ–≤–∞—è —ç–∫—Å–∫—É—Ä—Å–∏—è</h2>
    <form id="tourForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1" for="tourTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="tourTitle" type="text" required class="w-full px-3 py-2 border rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="tourDesc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="tourDesc" class="w-full px-3 py-2 border rounded"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="tourPrice">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞</label>
        <input id="tourPrice" type="number" step="0.01" min="0" required class="w-full px-3 py-2 border rounded" />
      </div>

      <div class="flex gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="tourCity">–ì–æ—Ä–æ–¥</label>
          <select id="tourCity" class="w-full px-3 py-2 border rounded"></select>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium mb-1" for="tourCat">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="tourCat" class="w-full px-3 py-2 border rounded"></select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1" for="tourImages">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</label>
        <input id="tourImages" type="file" accept="image/*" multiple class="w-full" />
      </div>

      <div>
        <h3 class="font-medium mb-2">–¢–∏–ø—ã –±–∏–ª–µ—Ç–æ–≤</h3>
        <div id="ticketRows" class="space-y-2"></div>
        <div class="flex gap-2 mt-2">
          <select id="ticketClassSel" class="flex-1 border rounded px-2 py-1 text-sm"></select>
          <input id="ticketPriceInput" type="number" step="0.01" min="0" placeholder="–¶–µ–Ω–∞" class="flex-1 border rounded px-2 py-1 text-sm" />
          <button type="button" id="addTicketBtn" class="px-3 py-1 bg-emerald-600 text-white rounded">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" id="cancelModal" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="px-4 py-2 rounded bg-cyan-600 text-white hover:bg-cyan-700">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('tourModal');
  const newBtn = document.getElementById('newTourBtn');
  const cancelBtn = document.getElementById('cancelModal');

  const openModal = () => { modal.classList.remove('hidden'); };
  const closeModal = () => { modal.classList.add('hidden'); };

  newBtn.addEventListener('click', async () => {
    await preloadSelects();
    openModal();
  });
  cancelBtn.addEventListener('click', closeModal);

  const loadTours = async () => {
    const res = await fetch('/api/v1/agency/tours');
    if (!res.ok) return;
    const tours = await res.json();
    const body = document.getElementById('toursBody');
    body.innerHTML = '';
    tours.forEach(t => {
      const tr = document.createElement('tr');
      const badge = formatScheduleBadge(t);
      tr.innerHTML = `
        <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${t.id}</td>
        <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${t.title}</td>
        <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${t.price}</td>
        <td class='px-6 py-4 whitespace-nowrap text-sm space-x-1'>${badge} <button data-id="${t.id}" class="addSched px-2 rounded bg-gray-200 hover:bg-gray-300">Ôºã</button></td>
        <td class='px-6 py-4 whitespace-nowrap text-right text-sm font-medium'></td>`;
      body.appendChild(tr);
    });
    body.querySelectorAll('.addSched').forEach(btn=>btn.addEventListener('click', (e)=>{
      const tid = e.target.getAttribute('data-id');
      openRecModal(tours.find(x=>x.id==tid));
    }));
  };

  const ticketRows = [];

  // Initial fetch
  loadTours();

  document.getElementById('addTicketBtn').addEventListener('click', () => {
    const clsSel = document.getElementById('ticketClassSel');
    const priceInput = document.getElementById('ticketPriceInput');
    const clsId = clsSel.value;
    const clsName = clsSel.options[clsSel.selectedIndex].text;
    const price = priceInput.value;
    if (!clsId || !price) return;
    ticketRows.push({ ticket_class_id: parseInt(clsId), name: clsName, price });
    renderTicketRows();
    priceInput.value = '';
  });

  const renderTicketRows = () => {
    const container = document.getElementById('ticketRows');
    container.innerHTML = ticketRows.map((r,i)=>`
      <div class="flex justify-between items-center bg-gray-50 px-3 py-1 rounded">
        <span>${r.name}</span>
        <span>${r.price}</span>
        <button data-idx="${i}" class="delTicket text-red-600">√ó</button>
      </div>
    `).join('');
    container.querySelectorAll('.delTicket').forEach(btn => {
      btn.addEventListener('click', (e)=>{
        const idx = e.target.getAttribute('data-idx');
        ticketRows.splice(idx,1);
        renderTicketRows();
      });
    });
  };

  async function preloadSelects(){
    // cities
    const cities = await fetch('/api/v1/cities').then(r=>r.json()).catch(()=>[]);
    const citySel = document.getElementById('tourCity');
    citySel.innerHTML = '<option value="">‚Äî</option>' + cities.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    // tour categories
    const tCats = await fetch('/api/v1/tour_categories').then(r=>r.json()).catch(()=>[]);
    const catSel = document.getElementById('tourCat');
    catSel.innerHTML = '<option value="">‚Äî</option>' + tCats.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    // ticket classes
    const tClass = await fetch('/api/v1/ticket_classes').then(r=>r.json()).catch(()=>[]);
    const clsSel = document.getElementById('ticketClassSel');
    clsSel.innerHTML = '<option value="">–¢–∏–ø</option>' + tClass.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  }

  document.getElementById('tourForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('tourTitle').value.trim();
    const description = document.getElementById('tourDesc').value.trim();
    const price = document.getElementById('tourPrice').value;
    const city_id = document.getElementById('tourCity').value || null;
    const category_id = document.getElementById('tourCat').value || null;
    if (!title || !price) return;
    const res = await fetch('/api/v1/agency/tours', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, description, price, city_id, category_id })
    });
    if (!res.ok) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫—Å–∫—É—Ä—Å–∏–∏'); return; }
    closeModal();
    document.getElementById('tourForm').reset();
    const { id } = await res.json();

    // Upload images if any
    const imgs = document.getElementById('tourImages').files;
    if (imgs && imgs.length){
      const fd = new FormData();
      for (const f of imgs) fd.append('files', f);
      await fetch(`/api/v1/agency/tours/${id}/images`, {method:'POST', body:fd});
    }

    // Add ticket categories
    for (const tc of ticketRows){
      await fetch(`/api/v1/agency/tours/${id}/categories`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(tc)
      });
    }

    ticketRows.length = 0;
    loadTours();
  });

  function fmtTime(t){return t?.slice(0,5);} // HH:MM
  const weekdaysRU=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
  function formatScheduleBadge(t){
    if(t.repeat_type==='daily') return `<span class="inline-block px-2 bg-emerald-100 rounded">üóì ${fmtTime(t.repeat_time)}</span>`;
    if(t.repeat_type==='weekly'){
      const days=t.repeat_weekdays.map(i=>weekdaysRU[i]).join(' ');
      return `<span class="inline-block px-2 bg-amber-100 rounded">‚è≤ ${fmtTime(t.repeat_time)} ‚Äî ${days}</span>`;
    }
    return '<span class="inline-block px-2 bg-gray-100 rounded">‚Äî</span>';
  }

  // Recurrence modal (simple prompt for now)
  function openRecModal(tour){
    const type = prompt('–¢–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (none|daily|weekly)', tour.repeat_type||'none');
    if(!type) return;
    let weekdays=null, time=null;
    if(type==='weekly'){
      weekdays = prompt('–î–Ω–∏ –Ω–µ–¥–µ–ª–∏ (0=–ü–Ω..6=–í—Å —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)', (tour.repeat_weekdays||[]).join(','));
      time = prompt('–í—Ä–µ–º—è HH:MM', tour.repeat_time||'09:00');
    }
    if(type==='daily'){
      time = prompt('–í—Ä–µ–º—è HH:MM', tour.repeat_time||'09:00');
    }
    fetch(`/api/v1/agency/tours/${tour.id}`, {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({repeat_type:type, repeat_weekdays: weekdays?weekdays.split(',').map(Number):null, repeat_time: time})}).then(()=>loadTours());
  }
})();
</script>
{% endblock %} 