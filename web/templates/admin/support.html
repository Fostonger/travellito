{% extends "base.html" %}
{% block title %}Support Messages - Admin{% endblock %}
{% block body %}
<div class="max-w-7xl mx-auto px-6 py-8">
  <h1 class="text-3xl font-extrabold text-indigo-700 mb-6">–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h1>
  
  <!-- Filters -->
  <div class="bg-white shadow rounded-xl p-6 mb-6">
    <form id="filterForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">–°—Ç–∞—Ç—É—Å</label>
        <select id="statusFilter" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="">–í—Å–µ</option>
          <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
          <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
          <option value="resolved">–†–µ—à–µ–Ω–æ</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">–¢–∏–ø</label>
        <select id="typeFilter" class="w-full rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
          <option value="">–í—Å–µ</option>
          <option value="question">–í–æ–ø—Ä–æ—Å</option>
          <option value="issue">–ü—Ä–æ–±–ª–µ–º–∞</option>
          <option value="payment_request">–ó–∞–ø—Ä–æ—Å –≤—ã–ø–ª–∞—Ç—ã</option>
        </select>
      </div>
      <div class="flex items-end">
        <button type="submit" class="inline-flex items-center px-4 py-2 bg-indigo-600 border border-transparent rounded-md font-semibold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 w-full">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>

  <!-- Messages Table -->
  <div class="bg-white shadow rounded-xl">
    <div class="overflow-x-auto rounded-xl">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¢–∏–ø</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°–æ–æ–±—â–µ–Ω–∏–µ</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ç–∞—Ç—É—Å</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°–æ–∑–¥–∞–Ω–æ</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="messagesTableBody" class="bg-white divide-y divide-gray-200">
          <tr>
            <td colspan="7" class="px-4 py-6 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Response Modal -->
<div class="modal fade" id="responseModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title font-semibold">–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body space-y-4">
        <div>
          <label class="form-label text-sm text-gray-600">–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
          <div class="p-3 bg-gray-100 rounded" id="originalMessage"></div>
        </div>
        <div>
          <label for="responseText" class="form-label text-sm text-gray-600">–í–∞—à –æ—Ç–≤–µ—Ç</label>
          <textarea class="form-control" id="responseText" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..." required></textarea>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="markResolved">
          <label class="form-check-label" for="markResolved">–ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Ä–µ—à—ë–Ω–Ω–æ–µ</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="sendResponseBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Payment Request Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title font-semibold">–ó–∞–ø—Ä–æ—Å –≤—ã–ø–ª–∞—Ç—ã</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body space-y-4">
        <div class="space-y-1">
          <p><span class="font-semibold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span> <span id="payUser"></span></p>
          <p><span class="font-semibold">–¢–µ–ª–µ—Ñ–æ–Ω:</span> <span id="payPhone"></span></p>
          <p><span class="font-semibold">–ë–∞–Ω–∫:</span> <span id="payBank"></span></p>
          <p><span class="font-semibold">–°—É–º–º–∞:</span> <span id="payAmount" class="text-lg font-bold"></span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button type="button" class="btn btn-success" id="markPaidBtn">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–ª–∞—á–µ–Ω–æ</button>
      </div>
    </div>
  </div>
</div>

<script>
/* Existing JS updated with nicer badge colors & message escaping */
const STATUS_BADGES = {
  pending: 'bg-yellow-100 text-yellow-800',
  in_progress: 'bg-blue-100 text-blue-800',
  resolved: 'bg-green-100 text-green-800'
};

let currentMessageId = null;

function escapeHtml(text){
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

async function loadMessages() {
  const status = document.getElementById('statusFilter').value;
  const type = document.getElementById('typeFilter').value;
  const params = new URLSearchParams();
  if (status) params.append('status', status);
  if (type) params.append('message_type', type);
  try {
    const response = await fetch(`/api/v1/support/messages?${params}`, { credentials: 'same-origin' });
    if (!response.ok) throw new Error('Failed to load messages');
    const messages = await response.json();
    messagesCache = messages;
    renderMessages(messages);
  } catch (error) {
    console.error('Error loading messages:', error);
    document.getElementById('messagesTableBody').innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
  }
}

function renderMessages(messages) {
  const tbody = document.getElementById('messagesTableBody');
  if (messages.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-center text-gray-500">–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
    return;
  }
  tbody.innerHTML = messages.map(msg => {
    const icon = msg.message_type === 'question' ? '‚ùì' : msg.message_type === 'issue' ? '‚ö†Ô∏è' : 'üí∞';
    const badgeClass = STATUS_BADGES[msg.status] || 'bg-gray-100 text-gray-800';
    const safeMsg = escapeHtml(msg.message);
    const actionBtn = msg.message_type !== 'payment_request'
      ? `<button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium" onclick="openResponseModal(${msg.id})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>`
      : `<button class="text-emerald-600 hover:text-emerald-800 text-sm font-medium" onclick="openPaymentModal(${msg.id})">–î–µ—Ç–∞–ª–∏</button>`;
    return `
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-3 font-medium text-sm text-gray-700">#${msg.id}</td>
        <td class="px-4 py-3 text-sm">${icon}</td>
        <td class="px-4 py-3 text-sm">${escapeHtml(msg.user.first || '')} ${escapeHtml(msg.user.last || '')}<br><span class="text-xs text-gray-500">@${escapeHtml(msg.user.username || 'no_username')}</span></td>
        <td class="px-4 py-3 text-sm max-w-xs truncate">${safeMsg}</td>
        <td class="px-4 py-3"><span class="px-2 py-0.5 rounded-full text-xs font-semibold ${badgeClass}">${msg.status}</span></td>
        <td class="px-4 py-3 text-sm">${new Date(msg.created_at).toLocaleString()}</td>
        <td class="px-4 py-3 text-center">${actionBtn}</td>
      </tr>`;
  }).join('');
}

function openResponseModal(messageId, message) {
  currentMessageId = messageId;
  document.getElementById('originalMessage').innerHTML = escapeHtml(message);
  document.getElementById('responseText').value = '';
  document.getElementById('markResolved').checked = false;
  new bootstrap.Modal(document.getElementById('responseModal')).show();
}

async function sendResponse(){
  const response = document.getElementById('responseText').value.trim();
  const markResolved = document.getElementById('markResolved').checked;
  if(!response){ alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞'); return; }
  try{
    const res = await fetch(`/api/v1/support/messages/${currentMessageId}/respond`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body:JSON.stringify({response, mark_resolved:markResolved})
    });
    if(!res.ok) throw new Error('Failed');
    bootstrap.Modal.getInstance(document.getElementById('responseModal')).hide();
    await loadMessages();
  }catch(err){console.error(err);alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');}
}

document.getElementById('sendResponseBtn').addEventListener('click', sendResponse);
document.getElementById('filterForm').addEventListener('submit', e=>{e.preventDefault();loadMessages();});
document.addEventListener('DOMContentLoaded', loadMessages);
setInterval(loadMessages, 30000);

const PAYMENT_REGEX = /–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø–ª–∞—Ç—É (\d+[.,]?\d*) ‚ÇΩ/i;
let messagesCache = [];

function openResponseModal(id){
  const m = messagesCache.find(x=>x.id===id);
  if(!m) return;
  currentMessageId=id;
  document.getElementById('originalMessage').innerHTML=escapeHtml(m.message);
  new bootstrap.Modal(document.getElementById('responseModal')).show();
}

function openPaymentModal(id){
  const m = messagesCache.find(x=>x.id===id);
  if(!m) return;
  currentMessageId=id;
  const match=m.message.match(PAYMENT_REGEX);
  const amount=match?match[1]:'';
  document.getElementById('payUser').textContent=`${m.user.first||''} ${m.user.last||''}`;
  document.getElementById('payAmount').textContent=amount+' ‚ÇΩ';
  const phoneLine=m.message.split('\n').find(l=>l.toLowerCase().includes('—Ç–µ–ª–µ—Ñ–æ–Ω'))||'';
  const bankLine=m.message.split('\n').find(l=>l.toLowerCase().includes('–±–∞–Ω–∫'))||'';
  document.getElementById('payPhone').textContent=phoneLine.replace('–¢–µ–ª–µ—Ñ–æ–Ω:','').trim();
  document.getElementById('payBank').textContent=bankLine.replace('–ë–∞–Ω–∫:','').trim();
  new bootstrap.Modal(document.getElementById('paymentModal')).show();
}

document.getElementById('markPaidBtn').addEventListener('click',async()=>{
  if(!currentMessageId) return;
  try{
    const res=await fetch(`/api/v1/support/messages/${currentMessageId}/respond`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body:JSON.stringify({response:'–í—ã–ø–ª–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é', mark_resolved:true})
    });
    if(!res.ok) throw new Error('fail');
    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
    await loadMessages();
  }catch(err){alert('–û—à–∏–±–∫–∞');}
});
</script>
{% endblock %} 