{% extends "base.html" %}
{% block title %}Управление агентствами{% endblock %}
{% block body %}
<div class="max-w-7xl mx-auto px-6 py-10">
  <h1 class="text-3xl font-extrabold text-indigo-700 mb-6">Агентства</h1>

  <!-- Add Agency Form -->
  <div class="mb-8 bg-white p-6 rounded-xl shadow">
    <h2 class="text-xl font-semibold mb-4">Добавить агентство</h2>
    <form id="addAgencyForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
      <div>
        <label for="agencyName" class="block text-sm font-medium text-gray-700 mb-1">Название</label>
        <input type="text" id="agencyName" required class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <label for="agencyApi" class="block text-sm font-medium text-gray-700 mb-1">API базовый URL (опц.)</label>
        <input type="url" id="agencyApi" class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Создать</button>
    </form>
  </div>

  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full divide-y divide-gray-200" id="agenciesTable">
      <thead class="bg-gray-50"><tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Название</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">API базовый URL</th>
        <th class="px-6 py-3"></th>
      </tr></thead>
      <tbody class="bg-white divide-y divide-gray-200" id="agenciesBody"></tbody>
    </table>
  </div>
</div>
<script>
(function(){
  const loadAgencies = async () => {
  const res = await fetch('/admin/api/agencies');
  if (!res.ok) return;
  const agencies = await res.json();
  const body = document.getElementById('agenciesBody');
    body.innerHTML = '';
  agencies.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${a.id}</td>
      <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${a.name}</td>
      <td class='px-6 py-4 whitespace-nowrap text-sm text-gray-900'>${a.api_base || ''}</td>
        <td class='px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4'>
          <a href='#' data-id='${a.id}' class='addUserLink text-emerald-600 hover:text-emerald-900'>+ пользователь</a>
          <a href='/admin/agency/${a.id}/sync' class='text-indigo-600 hover:text-indigo-900'>Синхр.</a>
        </td>`;
    body.appendChild(tr);
    });
  };

  loadAgencies();

  document.getElementById('addAgencyForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('agencyName').value.trim();
    const api_base = document.getElementById('agencyApi').value.trim();
    if (!name) return;
    const res = await fetch('/admin/api/agencies', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, api_base: api_base || null })
    });
    if (!res.ok) {
      alert('Ошибка создания агентства');
      return;
    }
    // Clear form and reload list
    document.getElementById('agencyName').value = '';
    document.getElementById('agencyApi').value = '';
    loadAgencies();
  });

  // ---------- Add agency user modal ----------
  const modal = document.createElement('div');
  modal.id = 'addUserModal';
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center hidden';
  modal.innerHTML = `
    <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-semibold mb-4">Новый пользователь агентства</h2>
      <form id="addUserForm" class="space-y-4">
        <input type="hidden" id="formAgencyId" />
        <div>
          <label class="block text-sm font-medium mb-1" for="userEmail">Email</label>
          <input id="userEmail" type="email" required class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="userFirst">Имя</label>
          <input id="userFirst" type="text" class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="userLast">Фамилия</label>
          <input id="userLast" type="text" class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="userPwd">Пароль</label>
          <input id="userPwd" type="password" required class="w-full px-3 py-2 border rounded" />
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancelUser" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Отмена</button>
          <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Создать</button>
        </div>
      </form>
    </div>`;
  document.body.appendChild(modal);

  const openModal = (aid) => {
    document.getElementById('formAgencyId').value = aid;
    modal.classList.remove('hidden');
  };
  const closeModal = () => { modal.classList.add('hidden'); };

  document.body.addEventListener('click', (e) => {
    if (e.target.classList.contains('addUserLink')) {
      e.preventDefault();
      const aid = e.target.getAttribute('data-id');
      openModal(aid);
    }
  });

  document.getElementById('cancelUser').addEventListener('click', closeModal);

  document.getElementById('addUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const agency_id = document.getElementById('formAgencyId').value;
    const email = document.getElementById('userEmail').value.trim();
    const first = document.getElementById('userFirst').value.trim() || null;
    const last = document.getElementById('userLast').value.trim() || null;
    const password = document.getElementById('userPwd').value;
    if (!email || !password) return;
    const res = await fetch('/admin/api/agency-users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agency_id: parseInt(agency_id), email, password, first, last })
    });
    if (!res.ok) { alert('Ошибка создания пользователя'); return; }
    closeModal();
    alert('Пользователь создан');
  });
})();
</script>
{% endblock %} 