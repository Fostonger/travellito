{% extends "base.html" %}
{% block title %}Глобальные настройки{% endblock %}
{% block body %}
<div class="max-w-3xl mx-auto px-6 py-10">
  <h1 class="text-3xl font-extrabold text-indigo-700 mb-6">Глобальные настройки</h1>
  <form id="settingsForm" class="space-y-6 bg-white p-6 rounded-xl shadow">
    <div>
      <label class="block mb-2 font-medium text-gray-700">Максимальная комиссия по умолчанию (%)</label>
      <input type="number" name="default_max_commission" min="0" max="100" step="0.1" class="w-full border rounded-lg px-3 py-2" required>
    </div>
    <button class="w-full py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Сохранить</button>
  </form>
  
  <div class="mt-10 bg-white p-6 rounded-xl shadow">
    <h2 class="text-xl font-bold text-indigo-700 mb-4">Настройка шаблона QR-кода</h2>
    <form id="qrTemplateForm" class="space-y-4">
      <div>
        <label class="block mb-2 font-medium text-gray-700">Фоновое изображение</label>
        <input type="file" name="qr_template" accept="image/png,image/jpeg" class="w-full" required>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block mb-2 font-medium text-gray-700">Позиция X (px)</label>
          <input type="number" name="qr_position_x" min="0" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block mb-2 font-medium text-gray-700">Позиция Y (px)</label>
          <input type="number" name="qr_position_y" min="0" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block mb-2 font-medium text-gray-700">Ширина QR (px)</label>
          <input type="number" name="qr_width" min="50" class="w-full border rounded-lg px-3 py-2" required>
        </div>
        <div>
          <label class="block mb-2 font-medium text-gray-700">Высота QR (px)</label>
          <input type="number" name="qr_height" min="50" class="w-full border rounded-lg px-3 py-2" required>
        </div>
      </div>
      
      <div class="mt-4">
        <label class="block mb-2 font-medium text-gray-700">Предпросмотр</label>
        <div class="flex flex-col items-center">
          <!-- A4 ratio wrapper with appropriate styling -->
          <div id="qrPreview" class="relative bg-white border border-gray-300 rounded-lg shadow-lg" style="width: 595px; height: 842px; /* A4 at 72dpi */"> 
            <div class="text-gray-400 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">Загрузите изображение для предпросмотра</div>
            <!-- QR code placeholder with pattern that looks like a QR code -->
            <div id="qrPlaceholder" class="absolute hidden">
              <div class="w-full h-full bg-white border border-gray-400 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-3/12 h-3/12 border-4 border-black bg-white"></div>
                <div class="absolute top-0 right-0 w-3/12 h-3/12 border-4 border-black bg-white"></div>
                <div class="absolute bottom-0 left-0 w-3/12 h-3/12 border-4 border-black bg-white"></div>
                <div class="absolute top-1/3 left-1/3 w-1/3 h-1/3 bg-black"></div>
                <!-- Grid pattern -->
                <div class="grid grid-cols-6 grid-rows-6 w-full h-full">
                  <div class="border border-gray-400"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-2 text-sm text-gray-500">Масштаб: A4 (210mm × 297mm)</div>
          <!-- Test PDF generation button -->
          <button type="button" id="testPdfButton" class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-200">
            <span class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Проверить PDF
            </span>
          </button>
        </div>
      </div>
      
      <button type="submit" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Сохранить шаблон</button>
    </form>
  </div>
</div>
<script>
(async () => {
  const res = await fetch('/api/v1/admin/settings');
  if (res.ok) {
    const s = await res.json();
    document.querySelector('[name=default_max_commission]').value = s.default_max_commission;
    
    // Set QR template settings if available
    if (s.qr_template) {
      document.querySelector('[name=qr_position_x]').value = s.qr_position_x || 50;
      document.querySelector('[name=qr_position_y]').value = s.qr_position_y || 50;
      document.querySelector('[name=qr_width]').value = s.qr_width || 200;
      document.querySelector('[name=qr_height]').value = s.qr_height || 200;
      
      // Show template preview
      updateQrPreview(s.qr_template_url, s.qr_position_x, s.qr_position_y, s.qr_width, s.qr_height);
    }
  }
})();

document.getElementById('settingsForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const data = {
    default_max_commission: parseFloat(form.default_max_commission.value)
  };
  const res = await fetch('/api/v1/admin/settings', {method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
  alert(res.ok ? 'Настройки сохранены' : 'Ошибка сохранения');
});

// QR template preview functionality
function updateQrPreview(imageUrl, x, y, width, height) {
  const previewEl = document.getElementById('qrPreview');
  const placeholderEl = document.getElementById('qrPlaceholder');
  
  // A4 dimensions at 72dpi
  const a4Width = 595;
  const a4Height = 842;
  
  // Clear existing content but keep the placeholder div
  const placeholderParent = placeholderEl.parentNode;
  const placeholderText = previewEl.querySelector('.text-gray-400');
  if (placeholderText) placeholderText.remove();
  
  if (imageUrl) {
    // Create background image
    const img = new Image();
    img.onload = function() {
      // Calculate scaling to fit the image within A4 bounds while maintaining aspect ratio
      const imgAspect = img.width / img.height;
      const a4Aspect = a4Width / a4Height;
      
      let scaledWidth, scaledHeight;
      
      if (imgAspect > a4Aspect) {
        // Image is wider than A4
        scaledWidth = a4Width;
        scaledHeight = a4Width / imgAspect;
      } else {
        // Image is taller than A4
        scaledHeight = a4Height;
        scaledWidth = a4Height * imgAspect;
      }
      
      // Center the image if it doesn't fill the entire A4
      const leftOffset = (a4Width - scaledWidth) / 2;
      const topOffset = (a4Height - scaledHeight) / 2;
      
      // Set background image
      previewEl.style.backgroundImage = `url(${imageUrl})`;
      previewEl.style.backgroundSize = `${scaledWidth}px ${scaledHeight}px`;
      previewEl.style.backgroundPosition = `${leftOffset}px ${topOffset}px`;
      previewEl.style.backgroundRepeat = 'no-repeat';
      
      // Calculate QR position adjusted for scaling
      // If the image is scaled, we need to adjust the QR position accordingly
      const scaleFactorX = scaledWidth / img.width;
      const scaleFactorY = scaledHeight / img.height;
      
      const adjustedX = x * scaleFactorX + leftOffset;
      const adjustedY = y * scaleFactorY + topOffset;
      const adjustedWidth = width * scaleFactorX;
      const adjustedHeight = height * scaleFactorY;
      
      // Show QR placement
      placeholderEl.style.display = 'block';
      placeholderEl.style.width = `${adjustedWidth}px`;
      placeholderEl.style.height = `${adjustedHeight}px`;
      placeholderEl.style.left = `${adjustedX}px`;
      placeholderEl.style.top = `${adjustedY}px`;
    };
    img.src = imageUrl;
  } else {
    // Reset background
    previewEl.style.backgroundImage = '';
    
    // Add text placeholder back
    const textEl = document.createElement('div');
    textEl.className = 'text-gray-400 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2';
    textEl.textContent = 'Загрузите изображение для предпросмотра';
    previewEl.appendChild(textEl);
    
    // Hide QR placeholder
    placeholderEl.style.display = 'none';
  }
}

// Handle template file upload and preview
document.querySelector('[name=qr_template]').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const x = parseInt(document.querySelector('[name=qr_position_x]').value) || 50;
      const y = parseInt(document.querySelector('[name=qr_position_y]').value) || 50;
      const width = parseInt(document.querySelector('[name=qr_width]').value) || 200;
      const height = parseInt(document.querySelector('[name=qr_height]').value) || 200;
      updateQrPreview(e.target.result, x, y, width, height);
    };
    reader.readAsDataURL(file);
  }
});

// Update preview when position/size changes
['qr_position_x', 'qr_position_y', 'qr_width', 'qr_height'].forEach(field => {
  document.querySelector(`[name=${field}]`).addEventListener('input', function() {
    const x = parseInt(document.querySelector('[name=qr_position_x]').value) || 50;
    const y = parseInt(document.querySelector('[name=qr_position_y]').value) || 50;
    const width = parseInt(document.querySelector('[name=qr_width]').value) || 200;
    const height = parseInt(document.querySelector('[name=qr_height]').value) || 200;
    
    const previewEl = document.getElementById('qrPreview');
    if (previewEl.style.backgroundImage) {
      updateQrPreview(document.querySelector('[name=qr_template]').files[0] ? 
        URL.createObjectURL(document.querySelector('[name=qr_template]').files[0]) : 
        previewEl.style.backgroundImage.replace(/url\(["']?([^"']*)["']?\)/i, "$1"),
        x, y, width, height);
    }
  });
});

// Handle QR template form submission
document.getElementById('qrTemplateForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData();
  
  if (form.qr_template.files[0]) {
    formData.append('qr_template', form.qr_template.files[0]);
  }
  
  formData.append('qr_position_x', form.qr_position_x.value);
  formData.append('qr_position_y', form.qr_position_y.value);
  formData.append('qr_width', form.qr_width.value);
  formData.append('qr_height', form.qr_height.value);
  
  const res = await fetch('/api/v1/admin/qr-template', {method: 'POST', body: formData});
  if (res.ok) {
    const data = await res.json();
    updateQrPreview(data.qr_template_url, data.position_x, data.position_y, data.width, data.height);
    alert('Шаблон QR-кода сохранен');
  } else {
    alert('Ошибка сохранения шаблона');
  }
});

// Handle test PDF button click
document.getElementById('testPdfButton').addEventListener('click', async () => {
  try {
    // Get the current QR template settings
    const posX = parseInt(document.querySelector('[name=qr_position_x]').value) || 50;
    const posY = parseInt(document.querySelector('[name=qr_position_y]').value) || 50;
    const width = parseInt(document.querySelector('[name=qr_width]').value) || 200;
    const height = parseInt(document.querySelector('[name=qr_height]').value) || 200;
    
    // First save the current settings
    const formData = new FormData();
    if (document.querySelector('[name=qr_template]').files[0]) {
      formData.append('qr_template', document.querySelector('[name=qr_template]').files[0]);
    }
    formData.append('qr_position_x', posX);
    formData.append('qr_position_y', posY);
    formData.append('qr_width', width);
    formData.append('qr_height', height);
    
    const saveRes = await fetch('/api/v1/admin/qr-template', {method: 'POST', body: formData});
    if (!saveRes.ok) {
      throw new Error('Не удалось сохранить настройки шаблона');
    }
    
    // Generate a test PDF with these settings
    window.open('/api/v1/admin/test-qr-pdf', '_blank');
  } catch (error) {
    alert('Ошибка: ' + error.message);
  }
});
</script>
{% endblock %} 